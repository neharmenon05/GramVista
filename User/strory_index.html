<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Storyteller AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --clay: #d8a48f;
            --terracotta: #bb8588;
            --mud: #8c5e58;
            --earth: #6b4d4d;
            --straw: #f0d8b8;
            --sky: #a7c4d4;
            --forest: #5a7247;
            --water: #4a8bb8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--straw);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(240, 216, 184, 0.8) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(167, 196, 212, 0.6) 0%, transparent 20%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M30,50 Q50,30 70,50 T90,50" fill="none" stroke="%23d8a48f" stroke-width="0.5"/></svg>');
            min-height: 100vh;
            padding: 20px;
            color: var(--earth);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 
                0 4px 20px rgba(107, 77, 77, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5),
                inset 0 0 30px rgba(240, 216, 184, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, var(--terracotta), var(--clay), var(--terracotta));
            border-radius: 15px 15px 0 0;
        }

        h1 {
            text-align: center;
            color: var(--mud);
            margin: 20px 0 30px;
            font-size: 2.2em;
            font-family: 'Noto Serif', serif;
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--terracotta), transparent);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--earth);
            font-size: 1em;
            padding-left: 5px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--clay);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Poppins', sans-serif;
            color: var(--earth);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
            box-shadow: 0 0 0 3px rgba(187, 133, 136, 0.2);
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, var(--terracotta), var(--mud));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(139, 93, 88, 0.3);
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            margin-top: 10px;
        }

        .generate-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 93, 88, 0.4);
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(to right, #cccccc, #999999);
        }

        .loading {
            text-align: center;
            margin: 30px 0;
            color: var(--mud);
            font-size: 1.1em;
        }

        .spinner {
            border: 4px solid rgba(216, 164, 143, 0.2);
            border-top: 4px solid var(--terracotta);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .story-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(107, 77, 77, 0.1);
            border-left: 4px solid var(--terracotta);
            position: relative;
            overflow: hidden;
        }

        .story-section::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23bb8588" opacity="0.1"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }

        .story-title {
            color: var(--mud);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 700;
            font-family: 'Noto Serif', serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .story-content {
            line-height: 1.8;
            color: var(--earth);
            font-size: 1em;
            margin-bottom: 15px;
            font-family: 'Noto Serif', serif;
        }

        .audio-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(187, 133, 136, 0.1);
            border-radius: 8px;
            text-align: center;
            border: 1px dashed var(--clay);
        }

        .audio-controls {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .audio-controls button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .audio-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .play-btn {
            background: var(--forest);
            color: white;
        }

        .stop-btn {
            background: var(--mud);
            color: white;
        }

        .test-btn {
            background: var(--water);
            color: white;
        }

        .error-message {
            background: rgba(187, 133, 136, 0.1);
            color: var(--mud);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--mud);
            font-weight: 500;
        }

        .warning-message {
            background: rgba(240, 216, 184, 0.5);
            color: var(--earth);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--straw);
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .language-info {
            display: inline-block;
            background: linear-gradient(to right, var(--forest), var(--water));
            color: white;
            padding: 3px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: 500;
        }

        .server-status {
            text-align: center;
            margin: 15px 0;
            font-weight: 600;
            padding: 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .server-online {
            background: rgba(90, 114, 71, 0.1);
            color: var(--forest);
            border: 1px solid var(--forest);
        }

        .server-offline {
            background: rgba(187, 133, 136, 0.1);
            color: var(--mud);
            border: 1px solid var(--mud);
        }

        .server-checking {
            background: rgba(240, 216, 184, 0.5);
            color: var(--earth);
            border: 1px solid var(--straw);
        }

        .village-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .ai-indicator {
            background: linear-gradient(to right, var(--forest), var(--water));
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        .sample-indicator {
            background: linear-gradient(to right, var(--terracotta), var(--mud));
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        .voice-info {
            margin: 10px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            font-size: 0.85em;
            border: 1px solid rgba(187, 133, 136, 0.2);
        }

        .native-indicator {
            color: var(--forest);
            font-weight: 600;
        }

        .fallback-indicator {
            color: var(--terracotta);
            font-weight: 600;
        }

        .note-text {
            color: var(--mud);
            font-style: italic;
            font-size: 0.85em;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .audio-controls {
                flex-direction: column;
                gap: 8px;
            }

            .audio-controls button {
                width: 100%;
            }

            .story-section {
                padding: 18px;
            }
        }

        /* Village decorative elements */
        .village-decoration {
            position: absolute;
            opacity: 0.1;
            z-index: -1;
        }

        .decoration-1 {
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236b4d4d"><path d="M12 3L4 9v12h16V9l-8-6zm-2.25 9.5c.69 0 1.25.56 1.25 1.25S10.44 15 9.75 15s-1.25-.56-1.25-1.25.56-1.25 1.25-1.25zM17 18h-1v-1.5H8V18H7v-7h1v4.5h3.5V12H17v6z"/></svg>');
            background-size: contain;
        }

        .decoration-2 {
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236b4d4d"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>');
            background-size: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="village-decoration decoration-1"></div>
        <div class="village-decoration decoration-2"></div>
        
        <h1>üè° Village Storyteller AI</h1>
        
        <div class="form-group">
            <label for="village"><span class="village-icon">üèòÔ∏è</span> Village Name:</label>
            <input type="text" id="village" value="Chettinad" placeholder="Enter your village name...">
        </div>

        <div class="form-group">
            <label for="language"><span class="village-icon">üåê</span> Story Language:</label>
            <select id="language">
                <option value="English">English</option>
                <option value="Hindi">Hindi</option>
                <option value="Tamil">Tamil</option>
                <option value="Telugu">Telugu</option>
                <option value="Marathi">Marathi</option>
                <option value="Malayalam">Malayalam</option>
            </select>
        </div>

        <button class="generate-btn" onclick="generateStory()">
            <span class="village-icon">üìú</span> Tell Me a Village Story
        </button>

        <div id="server-status" class="server-status server-checking">
            üîÑ Connecting to village storyteller...
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Gathering stories from the elders...</p>
        </div>

        <div id="results" style="display: none;"></div>
    </div>

    <script>
        const langCodes = {
            'English': 'en-US',
            'Hindi': 'hi-IN',
            'Tamil': 'ta-IN',
            'Telugu': 'te-IN',
            'Marathi': 'mr-IN',
            'Malayalam': 'ml-IN'
        };

        const translateLangCodes = {
            'English': 'en',
            'Hindi': 'hi',
            'Tamil': 'ta',
            'Telugu': 'te',
            'Marathi': 'mr',
            'Malayalam': 'ml'
        };

        // Sample stories for different villages (fallback when AI is not available)
        const sampleStories = {
            'Chettinad': {
                story: "In the heart of Tamil Nadu lies Chettinad, renowned for its magnificent mansions and aromatic cuisine. Legend speaks of the Chettiar merchants who traveled across seas, bringing back architectural marvels and culinary secrets. During the festival of Diwali, the grand mansions illuminate with thousands of oil lamps, while the air fills with the fragrance of freshly ground spices. The elders tell tales of how the famous Chettinad pepper was blessed by the goddess Meenakshi herself, giving it the power to heal and protect families for generations.",
                culture: "Known for palatial homes, spicy cuisine, and merchant heritage"
            },
            'Hampi': {
                story: "The ancient village of Hampi echoes with tales of the glorious Vijayanagara Empire. Local folklore tells of how the monkey god Hanuman was born here, among the boulder-strewn landscape. Every full moon night, villagers gather near the Tungabhadra river to sing ancient ballads about King Krishnadevaraya's court, where poets and musicians from across the world would showcase their talents. The ruins whisper stories of a time when gold and gems flowed like water, and the sound of temple bells resonated across the kingdom.",
                culture: "Ancient capital with ruins, temples, and royal heritage"
            },
            'Khajuraho': {
                story: "In the sacred village of Khajuraho, master craftsmen once carved stories in stone that would endure for centuries. The legend tells of how the moon god Chandra blessed a Brahmin woman, leading to the birth of Chandravarman, founder of the Chandela dynasty. During the spring festival of Holi, the intricately carved temples come alive with colors, and locals perform traditional dances that mirror the sculptures. Elders speak of how these temples were built to represent the cosmic dance of creation, where every carving tells a story of life, love, and spiritual awakening.",
                culture: "Famous for ancient temples with intricate sculptures and carvings"
            }
        };

        let serverStatus = false;
        let isGenerating = false;

        async function generateStory() {
            if (isGenerating) return;
            
            const village = document.getElementById('village').value.trim();
            const language = document.getElementById('language').value;
            
            if (!village) {
                alert('Please enter a village name');
                return;
            }

            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const generateBtn = document.querySelector('.generate-btn');
            
            // Show loading
            isGenerating = true;
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            generateBtn.disabled = true;
            
            try {
                let story = '';
                let useAI = false;
                
                // Check if LLaMA server is accessible
                const serverAvailable = await checkLlamaServer();
                
                if (serverAvailable) {
                    try {
                        // Try to get AI-generated story from LLaMA
                        story = await getAIStory(village);
                        if (story && story.trim().length > 0 && !story.toLowerCase().includes('error')) {
                            useAI = true;
                            console.log('Using AI-generated story');
                        } else {
                            throw new Error('Invalid AI response');
                        }
                    } catch (aiError) {
                        console.warn('AI generation failed, using fallback:', aiError.message);
                        story = getSampleStory(village);
                    }
                } else {
                    console.warn('LLaMA server not available, using sample story');
                    story = getSampleStory(village);
                }
                
                console.log('Generated story:', story.substring(0, 100) + '...');
                
                // Translate the story if needed
                let translatedStory = story;
                if (language !== 'English') {
                    try {
                        translatedStory = await translateText(story, translateLangCodes[language]);
                        console.log('Translation completed');
                    } catch (translateError) {
                        console.warn('Translation failed:', translateError.message);
                        translatedStory = story + ' (Translation not available)';
                    }
                }
                
                // Generate audio
                const audioElement = await generateAudio(translatedStory, langCodes[language]);
                
                // Display results
                displayResults(story, translatedStory, language, audioElement, useAI);
                
            } catch (error) {
                console.error('Error generating story:', error);
                showError(error.message || 'Failed to generate story. Please try again.');
            } finally {
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                isGenerating = false;
            }
        }

        async function checkLlamaServer() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('http://localhost:11434/api/tags', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('LLaMA server check timed out');
                } else {
                    console.error('LLaMA server check failed:', error);
                }
                return false;
            }
        }

        async function getAIStory(village) {
            try {
                console.log('Requesting story from LLaMA for village:', village);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'llama3.2',
                        prompt: `Write a detailed cultural story about the village of ${village}. Include local traditions, festivals, folklore, or legends. Make it engaging and culturally rich. Keep it to about 150-200 words.`,
                        stream: false
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('LLaMA response received');
                
                if (data && data.response) {
                    return data.response.trim();
                } else {
                    throw new Error('Invalid response format from LLaMA');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('LLaMA request timed out');
                }
                console.error('Error connecting to LLaMA API:', error);
                throw error;
            }
        }

        function getSampleStory(village) {
            const villageLower = village.toLowerCase();
            
            // Check if we have a specific story for this village
            for (const [key, value] of Object.entries(sampleStories)) {
                if (key.toLowerCase() === villageLower) {
                    return value.story;
                }
            }
            
            // Generate a generic story
            return `The village of ${village} is steeped in rich cultural heritage and ancient traditions. Local legends speak of brave warriors and wise sages who once walked these lands. During harvest festivals, the entire community comes together to celebrate with traditional music, dance, and storytelling. The elders pass down tales of miraculous events and divine interventions that have shaped the village's identity through generations. Every street corner and ancient tree holds memories of festivals celebrated, battles fought, and lives lived with honor and dignity. The village temple stands as a testament to the faith and devotion of its people, where prayers have been offered for centuries, creating an atmosphere of peace and spiritual connection.`;
        }

        async function translateText(text, targetLang) {
            if (targetLang === 'en') {
                return text; // No translation needed for English
            }
            
            try {
                console.log('Translating text to:', targetLang);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                // Using Google Translate API
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error('Translation service unavailable');
                }
                
                const data = await response.json();
                
                if (data && data[0] && Array.isArray(data[0])) {
                    const translatedText = data[0].map(item => item[0]).join('');
                    console.log('Translation successful');
                    return translatedText;
                } else {
                    throw new Error('Invalid translation response');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Translation request timed out');
                }
                console.error('Translation failed:', error);
                throw error;
            }
        }

        async function generateAudio(text, lang) {
            try {
                console.log('Generating audio for language:', lang);
                
                if ('speechSynthesis' in window) {
                    return new Promise((resolve) => {
                        const createUtterance = () => {
                            const utterance = new SpeechSynthesisUtterance(text);
                            
                            // Set language and speech parameters
                            utterance.rate = 0.8;
                            utterance.pitch = 1;
                            utterance.volume = 1;
                            
                            // Get available voices
                            const voices = speechSynthesis.getVoices();
                            console.log('Available voices:', voices.length);
                            
                            // Find the best voice for the language
                            let selectedVoice = null;
                            const langCode = lang.split('-')[0];
                            
                            // Priority order for finding voices
                            const voiceSearchStrategies = [
                                // 1. Exact language match
                                voice => voice.lang === lang,
                                // 2. Language code match
                                voice => voice.lang.startsWith(langCode),
                                // 3. Google voices for Indian languages
                                voice => voice.name.toLowerCase().includes('google') && voice.lang.includes(langCode),
                                // 4. Microsoft voices for Indian languages
                                voice => voice.name.toLowerCase().includes('microsoft') && voice.lang.includes(langCode),
                                // 5. Any voice containing the language code
                                voice => voice.lang.toLowerCase().includes(langCode.toLowerCase()),
                                // 6. Fallback to Hindi for Indian languages
                                voice => ['ta', 'te', 'mr', 'ml'].includes(langCode) && voice.lang.includes('hi'),
                                // 7. Fallback to English
                                voice => voice.lang.includes('en')
                            ];
                            
                            // Try each strategy in order
                            for (const strategy of voiceSearchStrategies) {
                                selectedVoice = voices.find(strategy);
                                if (selectedVoice) break;
                            }
                            
                            // Final fallback to first available voice
                            if (!selectedVoice && voices.length > 0) {
                                selectedVoice = voices[0];
                            }
                            
                            if (selectedVoice) {
                                utterance.voice = selectedVoice;
                                utterance.lang = selectedVoice.lang;
                                console.log('Selected voice:', selectedVoice.name, selectedVoice.lang);
                                
                                // Store voice info for display
                                utterance.voiceInfo = {
                                    name: selectedVoice.name,
                                    lang: selectedVoice.lang,
                                    isNative: selectedVoice.lang === lang || selectedVoice.lang.startsWith(langCode)
                                };
                            } else {
                                console.log('No suitable voice found, using default');
                                utterance.lang = lang;
                                utterance.voiceInfo = {
                                    name: 'Default',
                                    lang: lang,
                                    isNative: false
                                };
                            }
                            
                            resolve(utterance);
                        };
                        
                        // Handle voice loading
                        const voices = speechSynthesis.getVoices();
                        if (voices.length === 0) {
                            speechSynthesis.onvoiceschanged = () => {
                                console.log('Voices loaded');
                                createUtterance();
                            };
                            // Fallback timeout
                            setTimeout(createUtterance, 1000);
                        } else {
                            createUtterance();
                        }
                    });
                } else {
                    console.error('Speech synthesis not supported');
                    return null;
                }
            } catch (error) {
                console.error('Audio generation failed:', error);
                return null;
            }
        }

        function displayResults(originalStory, translatedStory, language, audioElement, useAI = false) {
            const resultsDiv = document.getElementById('results');
            
            const aiIndicator = useAI ? 
                '<span class="ai-indicator">AI Generated</span>' : 
                '<span class="sample-indicator">Sample Story</span>';
            
            resultsDiv.innerHTML = `
                <div class="story-section fade-in">
                    <h3 class="story-title">
                        <span class="village-icon">üìú</span> Original Story (English) 
                        ${aiIndicator}
                    </h3>
                    <div class="story-content">${originalStory}</div>
                </div>
                
                <div class="story-section fade-in">
                    <h3 class="story-title">
                        <span class="village-icon">üåç</span> Translated Story 
                        <span class="language-info">${language}</span>
                    </h3>
                    <div class="story-content">${translatedStory}</div>
                </div>
                
                <div class="story-section fade-in">
                    <h3 class="story-title">
                        <span class="village-icon">üéµ</span> Village Storyteller's Voice
                    </h3>
                    <div class="audio-section">
                        <p>Listen to the village elder tell this story:</p>
                        <div id="voice-info" class="voice-info"></div>
                        <div class="audio-controls">
                            <button class="play-btn" onclick="playAudio()">
                                <span class="village-icon">üîä</span> Play Story
                            </button>
                            <button class="stop-btn" onclick="stopAudio()">
                                <span class="village-icon">‚èπÔ∏è</span> Stop
                            </button>
                            <button class="test-btn" onclick="testVoices()">
                                <span class="village-icon">üé§</span> Test Voices
                            </button>
                            <button class="test-btn" onclick="checkLanguageSupport('${language}')">
                                <span class="village-icon">üîç</span> Check ${language} Support
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Store audio element for playback
            window.currentAudio = audioElement;
            
            resultsDiv.style.display = 'block';
        }

        function playAudio() {
            if (window.currentAudio) {
                // Stop any currently playing speech
                speechSynthesis.cancel();
                
                // Show voice info
                if (window.currentAudio.voiceInfo) {
                    const voiceInfoDiv = document.getElementById('voice-info');
                    if (voiceInfoDiv) {
                        const voiceInfo = window.currentAudio.voiceInfo;
                        const nativeIndicator = voiceInfo.isNative ? 
                            '<span class="native-indicator">‚úì Native Voice</span>' : 
                            '<span class="fallback-indicator">‚ö†Ô∏è Fallback Voice</span>';
                        
                        voiceInfoDiv.innerHTML = `
                            <strong>Storyteller:</strong> ${voiceInfo.name} (${voiceInfo.lang}) ${nativeIndicator}
                            ${!voiceInfo.isNative ? '<div class="note-text">Note: Using fallback voice as native language voice is not available</div>' : ''}
                        `;
                    }
                }
                
                // Play the new audio
                speechSynthesis.speak(window.currentAudio);
                
                // Update button text during playback
                const playButton = document.querySelector('.play-btn');
                if (playButton) {
                    playButton.innerHTML = '<span class="village-icon">üîä</span> Listening...';
                    playButton.disabled = true;
                }
                
                // Re-enable button when speech ends
                window.currentAudio.onend = () => {
                    if (playButton) {
                        playButton.innerHTML = '<span class="village-icon">üîä</span> Play Story';
                        playButton.disabled = false;
                    }
                };
                
                window.currentAudio.onerror = () => {
                    if (playButton) {
                        playButton.innerHTML = '<span class="village-icon">üîä</span> Play Story';
                        playButton.disabled = false;
                    }
                    console.error('Audio playback failed');
                };
            } else {
                alert('Storyteller not available. Please try generating the story again.');
            }
        }

        function stopAudio() {
            speechSynthesis.cancel();
            
            // Reset button text
            const playButton = document.querySelector('.play-btn');
            if (playButton) {
                playButton.innerHTML = '<span class="village-icon">üîä</span> Play Story';
                playButton.disabled = false;
            }
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="error-message">
                    <strong>Village Notice:</strong> ${message}
                </div>
            `;
            resultsDiv.style.display = 'block';
        }

        // Load voices when page loads and handle voice loading
        window.addEventListener('load', async () => {
            if ('speechSynthesis' in window) {
                // Load voices
                speechSynthesis.getVoices();
                
                // Handle voice loading for different browsers
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => {
                        console.log('Voices loaded:', speechSynthesis.getVoices().length);
                        const voices = speechSynthesis.getVoices();
                        console.log('Available languages:', [...new Set(voices.map(v => v.lang))]);
                    };
                }
            }
            
            // Check server status
            await updateServerStatus();
            
            // Refresh server status every 30 seconds
            setInterval(updateServerStatus, 30000);
        });

        function testVoices() {
            const voices = speechSynthesis.getVoices();
            console.log('=== ALL AVAILABLE VOICES ===');
            voices.forEach((voice, index) => {
                console.log(`${index}: ${voice.name} (${voice.lang}) - ${voice.localService ? 'Local' : 'Remote'}`);
            });
            
            const indianVoices = voices.filter(voice => 
                voice.lang.includes('hi') || voice.lang.includes('ta') || 
                voice.lang.includes('te') || voice.lang.includes('mr') || 
                voice.lang.includes('ml')
            );
            
            console.log('=== INDIAN LANGUAGE VOICES ===');
            indianVoices.forEach((voice, index) => {
                console.log(`${index}: ${voice.name} (${voice.lang})`);
            });
            
            const supportedLangs = {
                'Hindi': voices.filter(v => v.lang.includes('hi')).length,
                'Tamil': voices.filter(v => v.lang.includes('ta')).length,
                'Telugu': voices.filter(v => v.lang.includes('te')).length,
                'Marathi': voices.filter(v => v.lang.includes('mr')).length,
                'Malayalam': voices.filter(v => v.lang.includes('ml')).length,
                'English': voices.filter(v => v.lang.includes('en')).length
            };
            
            let supportMessage = `Found ${voices.length} total storytellers:\n`;
            for (const [lang, count] of Object.entries(supportedLangs)) {
                supportMessage += `${lang}: ${count} voices\n`;
            }
            
            alert(supportMessage + '\nCheck browser console for detailed voice list.');
        }
        
        function checkLanguageSupport(language) {
            const voices = speechSynthesis.getVoices();
            const langCode = langCodes[language];
            const shortCode = langCode.split('-')[0];
            
            const exactMatches = voices.filter(voice => voice.lang === langCode);
            const partialMatches = voices.filter(voice => voice.lang.includes(shortCode));
            const fallbackVoices = voices.filter(voice => voice.lang.includes('en') || voice.lang.includes('hi'));
            
            let message = `Language Support for ${language} (${langCode}):\n\n`;
            
            if (exactMatches.length > 0) {
                message += `‚úÖ Exact matches: ${exactMatches.length}\n`;
                exactMatches.forEach(voice => {
                    message += `  ‚Ä¢ ${voice.name} (${voice.lang})\n`;
                });
            } else {
                message += `‚ùå No exact matches found\n`;
            }
            
            if (partialMatches.length > 0) {
                message += `\n‚ö†Ô∏è Partial matches: ${partialMatches.length}\n`;
                partialMatches.forEach(voice => {
                    message += `  ‚Ä¢ ${voice.name} (${voice.lang})\n`;
                });
            }
            
            if (exactMatches.length === 0 && partialMatches.length === 0) {
                message += `\nüîÑ Will use fallback voices:\n`;
                fallbackVoices.slice(0, 3).forEach(voice => {
                    message += `  ‚Ä¢ ${voice.name} (${voice.lang})\n`;
                });
                
                message += `\nüí° To get native ${language} voices:\n`;
                message += `1. Install Google Chrome (best support)\n`;
                message += `2. Enable "Use system voices" in browser settings\n`;
                message += `3. Install ${language} language pack in your OS\n`;
                message += `4. Try Microsoft Edge for more Indian language support`;
            }
            
            alert(message);
        }

        // Add server status indicator
        async function updateServerStatus() {
            const statusDiv = document.getElementById('server-status');
            
            if (!statusDiv) return;
            
            statusDiv.className = 'server-status server-checking';
            statusDiv.innerHTML = 'üîÑ Connecting to village storyteller...';
            
            try {
                const serverAvailable = await checkLlamaServer();
                serverStatus = serverAvailable;
                
                if (serverAvailable) {
                    statusDiv.className = 'server-status server-online';
                    statusDiv.innerHTML = 'üü¢ Village Storyteller: Connected & Ready';
                } else {
                    statusDiv.className = 'server-status server-offline';
                    statusDiv.innerHTML = 'üî¥ Village Storyteller: Not Available (Using village archives)';
                }
            } catch (error) {
                serverStatus = false;
                statusDiv.className = 'server-status server-offline';
                statusDiv.innerHTML = 'üî¥ Village Storyteller: Connection Error';
            }
        }

        // Handle page visibility changes to refresh server status
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateServerStatus();
            }
        });
    </script>
</body>
</html>