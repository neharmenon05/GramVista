<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gram Vista – Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .logo i {
      color: #667eea;
      font-size: 28px;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .toggle-panel-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: none;
    }

    .toggle-panel-btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    /* Sidebar */
    .sidebar {
      width: 350px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      height: 100vh;
      overflow: hidden;
      box-shadow: 2px 0 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      z-index: 999;
      margin-top: 70px;
      height: calc(100vh - 70px);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .search-container {
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .search-box {
      position: relative;
      display: flex;
      align-items: center;
    }

    #search {
      width: 100%;
      padding: 15px 50px 15px 20px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    #search:focus {
      background: white;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .search-icon {
      position: absolute;
      right: 15px;
      color: #667eea;
      font-size: 18px;
    }

    .info-content {
      height: calc(100% - 100px);
      overflow-y: auto;
      padding: 0 20px 20px;
    }

    .info-content::-webkit-scrollbar {
      width: 6px;
    }

    .info-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .info-content::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      border-radius: 15px;
      color: white;
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #00ff88;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .village-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideIn 0.5s ease;
    }

    .village-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .village-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .village-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .village-title {
      flex: 1;
    }

    .village-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .village-desc {
      color: #666;
      font-size: 14px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .metric-item {
      background: rgba(102, 126, 234, 0.1);
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .metric-item:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: scale(1.05);
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .services-section {
      margin-top: 15px;
    }

    .services-title {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .service-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .service-tag {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .service-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    /* Map */
    #map {
      flex: 1;
      height: 100vh;
      margin-top: 70px;
      height: calc(100vh - 70px);
    }

    /* Pulse animation for markers */
    .pulse {
      background: radial-gradient(circle, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.6) 100%);
      border-radius: 50%;
      width: 25px;
      height: 25px;
      animation: pulse 2s infinite;
      border: 3px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    /* Animations */
    @keyframes pulse {
      0% { 
        transform: scale(1); 
        opacity: 1; 
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      }
      100% { 
        transform: scale(2.5); 
        opacity: 0; 
        box-shadow: 0 0 40px rgba(102, 126, 234, 0.2);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Loading animation */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #667eea;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        z-index: 1001;
        width: 100%;
        max-width: 350px;
      }

      .toggle-panel-btn {
        display: block;
      }

      #map {
        margin-left: 0;
      }

      .header {
        padding: 0 15px;
      }

      .logo {
        font-size: 20px;
      }
    }

    /* Custom popup styles */
    .mapboxgl-popup-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .mapboxgl-popup-tip {
      border-top-color: rgba(255, 255, 255, 0.95);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-map-marked-alt"></i>
        Gram Vista
      </div>
      <div class="header-controls">
        <button class="toggle-panel-btn" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i> Menu
        </button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="search" placeholder="Search villages, landmarks...">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>
      
      <div class="info-content">
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>Live data streaming...</span>
        </div>
        
        <div id="info">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading village data...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGVkZWVweWExMjMiLCJhIjoiY21kajFxZjNtMGthODJpcG1wNXhmamtpcyJ9.O0GYBXWiDl-LwHAJXzVPyQ';
    
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [77.5946, 12.9716],
      zoom: 15,
      pitch: 45,
      bearing: -17.6,
      antialias: true
    });

    // Add map controls
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }), 'top-right');

    const socket = io();
    let markers = [];

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
    }

    function getEcoScoreColor(score) {
      if (score >= 80) return '#00ff88';
      if (score >= 60) return '#ffeb3b';
      if (score >= 40) return '#ff9800';
      return '#f44336';
    }

    function getAQIColor(aqi) {
      if (aqi <= 50) return '#00ff88';
      if (aqi <= 100) return '#ffeb3b';
      if (aqi <= 150) return '#ff9800';
      return '#f44336';
    }

    socket.on("village_update", data => {
      const infoPanel = document.getElementById('info');
      infoPanel.innerHTML = "";
      
      // Clear existing markers
      markers.forEach(m => m.remove());
      markers = [];

      if (data.length === 0) {
        infoPanel.innerHTML = `
          <div class="loading">
            <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #ff9800; margin-bottom: 15px;"></i>
            <p>No village data available</p>
          </div>
        `;
        return;
      }

      data.forEach((v, index) => {
        const ecoScore = Math.floor(Math.random() * 100);
        
        // Enhanced popup content
        const popupContent = `
          <div style="min-width: 250px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div>
                <strong style="font-size: 16px; color: #333;">${v.name}</strong><br/>
                <span style="color: #666; font-size: 14px;">${v.desc}</span>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
              <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold; color: #667eea;">${v.temperature}°C</div>
                <div style="font-size: 11px; color: #666;">Temperature</div>
              </div>
              <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold; color: ${getAQIColor(v.aqi)};">${v.aqi}</div>
                <div style="font-size: 11px; color: #666;">AQI</div>
              </div>
              <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold; color: #667eea;">${v.footfall}</div>
                <div style="font-size: 11px; color: #666;">Footfall</div>
              </div>
              <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold; color: ${getEcoScoreColor(ecoScore)};">${ecoScore}</div>
                <div style="font-size: 11px; color: #666;">Eco-Score</div>
              </div>
            </div>
            
            <div style="margin-top: 15px;">
              <div style="font-size: 14px; font-weight: bold; color: #333; margin-bottom: 8px;">
                <i class="fas fa-concierge-bell"></i> Nearby Services
              </div>
              <div style="font-size: 13px; line-height: 1.6;">
                🏨 <strong>Hotels:</strong> ${v.pois.homestays.map(p => p.name).join(", ") || "None"}<br/>
                🗺 <strong>Tourist Places:</strong> ${v.pois.tourist_spots.map(p => p.name).join(", ") || "None"}<br/>
                🛍 <strong>Shops:</strong> ${v.pois.shops.map(p => p.name).join(", ") || "None"}<br/>
                🚌 <strong>Transport:</strong> Available
              </div>
            </div>
          </div>
        `;

        // Create village card for sidebar
        const villageCard = `
          <div class="village-card" style="animation-delay: ${index * 0.1}s;">
            <div class="village-header">
              <div class="village-icon">
                <i class="fas fa-home"></i>
              </div>
              <div class="village-title">
                <div class="village-name">${v.name}</div>
                <div class="village-desc">${v.desc}</div>
              </div>
            </div>
            
            <div class="metrics-grid">
              <div class="metric-item">
                <div class="metric-value">${v.temperature}°C</div>
                <div class="metric-label">Temperature</div>
              </div>
              <div class="metric-item">
                <div class="metric-value" style="color: ${getAQIColor(v.aqi)}">${v.aqi}</div>
                <div class="metric-label">AQI</div>
              </div>
              <div class="metric-item">
                <div class="metric-value">${v.footfall}</div>
                <div class="metric-label">Footfall</div>
              </div>
              <div class="metric-item">
                <div class="metric-value" style="color: ${getEcoScoreColor(ecoScore)}">${ecoScore}</div>
                <div class="metric-label">Eco-Score</div>
              </div>
            </div>
            
            <div class="services-section">
              <div class="services-title">
                <i class="fas fa-map-signs"></i>
                Nearby Services
              </div>
              <div class="service-list">
                ${v.pois.homestays.map(p => `<span class="service-tag">🏨 ${p.name}</span>`).join('')}
                ${v.pois.tourist_spots.map(p => `<span class="service-tag">🗺 ${p.name}</span>`).join('')}
                ${v.pois.shops.map(p => `<span class="service-tag">🛍 ${p.name}</span>`).join('')}
              </div>
            </div>
          </div>
        `;

        infoPanel.innerHTML += villageCard;

        // Create main village marker
        const el = document.createElement('div');
        el.className = 'pulse';
        const popup = new mapboxgl.Popup({ 
          offset: 25,
          closeButton: true,
          closeOnClick: false
        }).setHTML(popupContent);
        
        const marker = new mapboxgl.Marker(el)
          .setLngLat(v.coords)
          .setPopup(popup)
          .addTo(map);
        markers.push(marker);

        // Helper function to add category markers
        const addCategoryMarkers = (items, emoji, color) => {
          items.forEach(poi => {
            const icon = document.createElement('div');
            icon.innerHTML = emoji;
            icon.style.cssText = `
              font-size: 22px;
              cursor: pointer;
              background: ${color};
              border-radius: 50%;
              width: 35px;
              height: 35px;
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 4px 15px rgba(0,0,0,0.2);
              transition: all 0.3s ease;
              border: 2px solid white;
            `;
            
            // Removed hover scale effect - icons now stay static
            
            const m = new mapboxgl.Marker(icon)
              .setLngLat(poi.coords)
              .setPopup(new mapboxgl.Popup({ offset: 15 }).setHTML(`
                <div style="text-align: center; padding: 10px;">
                  <div style="font-size: 24px; margin-bottom: 8px;">${emoji}</div>
                  <strong style="color: #333;">${poi.name}</strong><br/>
                  <span style="color: #666; font-size: 13px;">Click for details</span>
                </div>
              `))
              .addTo(map);
            markers.push(m);
          });
        };

        // Add POI markers with different colors
        addCategoryMarkers(v.pois.homestays, '🏨', 'linear-gradient(135deg, #ff6b6b, #ee5a52)');
        addCategoryMarkers(v.pois.tourist_spots, '🗺', 'linear-gradient(135deg, #4ecdc4, #44a08d)');
        addCategoryMarkers(v.pois.shops, '🛍', 'linear-gradient(135deg, #45b7d1, #96c93d)');

        // Clean up route layers
        if (map.getLayer('route-line-layer')) {
          map.removeLayer('route-line-layer');
        }
        if (map.getSource('route-line')) {
          map.removeSource('route-line');
        }
      });
    });

    // Enhanced search functionality
    document.getElementById("search").addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        const query = e.target.value.trim();
        if (!query) return;

        // Add loading state
        e.target.style.background = 'rgba(255, 255, 255, 0.7)';
        e.target.disabled = true;

        try {
          const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}`;
          const res = await fetch(url);
          const data = await res.json();
          
          if (data.features.length > 0) {
            const place = data.features[0];
            const coords = place.center;
            const name = place.place_name;

            map.flyTo({ 
              center: coords, 
              zoom: 14,
              bearing: -17.6,
              pitch: 45,
              duration: 2000
            });
            
            socket.emit('custom_location', { coords, name });
          } else {
            // Show custom alert
            showNotification("Location not found. Try a different search term.", 'warning');
          }
        } catch (error) {
          showNotification("Search failed. Please try again.", 'error');
        } finally {
          e.target.style.background = 'rgba(255, 255, 255, 0.9)';
          e.target.disabled = false;
        }
      }
    });

    // Enhanced map click handler
    map.on('click', async (e) => {
      const coords = [e.lngLat.lng, e.lngLat.lat];
      
      try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${mapboxgl.accessToken}`;
        const res = await fetch(url);
        const data = await res.json();
        const name = data.features?.[0]?.place_name || "Unknown Location";

        socket.emit('custom_location', { coords, name });
        showNotification(`Exploring: ${name}`, 'info');
      } catch (error) {
        showNotification("Unable to get location details", 'warning');
      }
    });

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 90px;
        right: 20px;
        background: ${type === 'error' ? 'linear-gradient(135deg, #ff6b6b, #ee5a52)' : 
                    type === 'warning' ? 'linear-gradient(135deg, #ffa726, #fb8c00)' : 
                    'linear-gradient(135deg, #4facfe, #00f2fe)'};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 300px;
        font-size: 14px;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Add slide animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Initialize
    showNotification("Gram Vista loaded successfully!", 'info');
  </script>
</body>
</html>